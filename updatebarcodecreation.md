# Backend: Auto-Generate Barcode on Outlet Creation

**Purpose:** Each outlet must have a **unique barcode** for worker shift check-in. The barcode should be **auto-generated by the backend** when an outlet is created (or when an employer is created/updated with outlets). The admin panel does **not** send or edit barcode; it only displays the barcode returned by the API.

---

## 1. When to Generate Barcode

- **On outlet creation:** Whenever a new outlet is created (either via **Create Employer** with outlets, or **Update Employer** with new outlets, or **Create Outlet** endpoint), the backend must generate a **unique barcode** for that outlet and persist it.
- **Existing outlets:** If any outlet in the database does not yet have a `barcode` field, you may run a one-time migration to generate and assign barcodes for them.

---

## 2. Barcode Format & Uniqueness

- **Format:** Use a format that is easy to scan and unique. Examples:
  - Alphanumeric string: e.g. `OUT-{random 8–12 chars}` or `WL-{nanoid}`.
  - Or a short UUID segment, or a base36/hex encoded random value.
- **Uniqueness:** Each outlet’s `barcode` must be **unique** across all outlets. Before saving, check that the generated value does not already exist in the outlets collection.
- **Length:** Recommend 10–16 characters for a good balance between uniqueness and scan/display.

**Example generation (pseudo):**

```text
barcode = "OUT-" + randomAlphanumeric(10)   // e.g. OUT-A1B2C3D4E5
// Or use nanoid, crypto.randomBytes, etc.
// Ensure uniqueness: query outlets by barcode; if exists, regenerate.
```

---

## 3. API Contract

### 3.1 Create Employer (`POST /api/admin/employers`)

- Request body may include an `outlets` array (optional).
- For **each** outlet in the request:
  - Create the outlet document.
  - **Auto-generate** a unique `barcode` for that outlet (do not accept barcode from client).
  - Save the outlet with `barcode` set.
- Response must include the created employer with **outlets array**, and each outlet must include the **`barcode`** field in the response.

### 3.2 Update Employer (`PUT /api/admin/employers/:employerId`)

- Request body may include an `outlets` array (existing + new outlets).
- For **new** outlets (no `_id` or `_id` not found in DB):
  - Create the outlet.
  - **Auto-generate** a unique `barcode` and save.
- For **existing** outlets (matched by `_id`):
  - Do **not** overwrite `barcode`; keep the existing one. (Only regenerate if you have a specific “regenerate barcode” feature.)
- Response must return the employer with all outlets including their **`barcode`** values.

### 3.3 Create Outlet (`POST /api/admin/outlets`)

- When creating a single outlet, **auto-generate** a unique `barcode` and attach it to the new outlet document.
- Response must include the created outlet with **`barcode`** in the payload.

### 3.4 Get Employer / Get Outlets

- **GET /api/admin/employers**, **GET /api/admin/employers/:id**, **GET /api/admin/outlets**, **GET /api/admin/outlets/:id**
- Every outlet in the response must include the **`barcode`** field (string, unique per outlet).

---

## 4. Database

- **Outlets collection/schema:** Add a field `barcode` (string, required, unique, indexed).
- **Index:** Create a unique index on `barcode` so that duplicate barcodes cannot be inserted and lookups by barcode (e.g. for validate-barcode) are fast.

**Example (MongoDB):**

```javascript
// Schema
outletSchema = {
  name: String,
  address: String,
  // ... other fields
  barcode: { type: String, required: true, unique: true }
};
// Index
db.outlets.createIndex({ barcode: 1 }, { unique: true });
```

---

## 5. Validate Barcode (Existing Behaviour)

- The **Validate Barcode** endpoint (`POST /api/qr/validate-barcode`) receives `barcode` (or `userId`) and returns outlet/shift info. No change to this contract is required; ensure it looks up the outlet by the **`barcode`** field that you now auto-generate and store.

---

## 6. Summary Checklist for Backend

| Task | Description |
|------|-------------|
| Add `barcode` to outlet model | Required, unique, string. |
| Unique index on `barcode` | Prevent duplicates, speed up lookup. |
| Generate on Create Employer (outlets) | For each new outlet in the request, generate unique barcode and save. |
| Generate on Update Employer (new outlets) | For each outlet without existing `_id` in DB, generate unique barcode. |
| Generate on Create Outlet | Single outlet creation: generate and attach barcode. |
| Do not accept `barcode` from client | Ignore if sent in request; always generate server-side. |
| Return `barcode` in all outlet responses | GET employers, GET employer by id, GET outlets, GET outlet by id. |
| Optional: migration | One-time script to add barcode to existing outlets that don’t have one. |

---

## 7. Frontend (Admin Panel) Assumption

- The admin panel **does not** send `barcode` when creating or updating employers/outlets.
- It **only displays** the `barcode` returned by the API (e.g. on Edit Employer outlet cards and Outlet Detail page) so that staff can share it for shift check-in (e.g. printed at the outlet).

Once the backend implements the above, barcodes will be **auto-generated on outlet creation** and the admin UI will show them without any further frontend changes.
